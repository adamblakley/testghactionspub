name: Plugin Release Workflow
on:
  workflow_dispatch:
    inputs:
      PLUGIN_NAME:
        description: 'Plugin to release. The name must match the plugin directory name in GitHub. Multiple plugins can be entered, separated by commas (freegeoip,jira,etc).'
        required: false
  pull_request:
    types: [closed]
    branches:
      - master

permissions:
  contents: write
  actions: read

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        id: checkoutRepository
        uses: actions/checkout@v3
        with:
          fetch-depth: 5
          ref: "refs/heads/master"

      - name: Find the filename
        id: find-filename
        run: |
          # Navigate to the desired directory
          cd ./github/workflows/builds

          # Use find to get the filename
          filename=$(find . -type f -maxdepth 1)
          
          # Set the output variable for later use
          echo "RELEASE_ASSET=${filename}" >> $GITHUB_ENV

      - name: Extract the Git tag
        run: |
          echo "Found Filename: ${{ env.RELEASE_ASSET }}"
          GIT_TAG="${{ env.RELEASE_ASSET }}%.tar.gz"
          echo "GIT_TAG=${GIT_TAG}" >> $GITHUB_ENV

      - name: Create release
        id: createRelease
        uses: actions/create-release@v1
        with:
          tag_name: ${{ GIT_TAG }}
          release_name: ${{ GIT_TAG }}
          body: |
            ${{ GIT_TAG }}
          draft: false
          prerelease: false

      - name: Upload release asset
        id: uploadReleaseAsset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.createRelease.outputs.upload_url }}
          asset_path: ./github/workflows/builds/${{ RELEASE_ASSET }}.tar.gz
          asset_name: ${{ RELEASE_ASSET }}
          asset_content_type: application/gzip
